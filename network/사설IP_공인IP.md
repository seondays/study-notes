## NAT (Network Adress Translation)
네트워크 주소 변환을 의미하는 NAT란, 여러 장치가 동일한 공인 IP 주소를 이용하여 인터넷에 접근할 수 있도록 하는 기술을 의미한다.

공인 IP의 내부 네트워크에 속해 있는 장치들에는 각각 사설 IP 주소가 할당되며, 외부 인터넷과 통신하고자 할 때 이것을 공인 IP로 변환하여 사용한다.

원래라면 이 서로 다른 기기들은 각자의 공인 IP를 가지고 있어야 인터넷과 통신할 수 있을 것이다. 하지만 NAT를 이용하면 하나의 공인 IP만으로 기기들 모두가 인터넷에 접근할 수 있기 때문에, NAT는 IPv4의 주소 부족을 해결하기 위한 방법들 중 하나로 사용되고 있다.

### 작동 방식
일반적으로 NAT는 내부 네트워크와 외부 네트워크의 경계에 있는 라우터나 게이트웨이에서 동작한다.

#### 사설 IP → 공인 IP 변환
1. 내부 네트워크의 컴퓨터가 인터넷 통신을 요청하면 해당 요청은 게이트웨이를 거치는데, 이때 게이트웨이는 패킷의 출발지 주소를 사설 IP 주소에서 공인 IP 주소로 변경 (해당 과정에서 출발지 포트 역시 변경될 수도 있음)
2. 동시에 게이트웨이는 원래의 사설 IP 주소, 포트 번호, 변경된 공인 IP 주소 등을 NAT 테이블에 기록해둠
3. 변환된 패킷은 외부 인터넷으로 전송되어 목적지에 도달하는데, 당연히 외부 목적지에서는 사설 IP 주소를 알 수 없으며 공인 IP 주소만을 알고 있음

#### 공인 IP → 사설 IP 변환
1. 외부 인터넷에서 응답 패킷이 돌아오는데, 응답은 게이트웨이 공인 IP 주소를 대상으로 하고 있음
2. 게이트웨이는 수신한 응답 패킷을 NAT 테이블에 저장해 둔 정보와 비교
3. 비교한 내용을 바탕으로 어떤 사설 IP 주소로 다시 변환해야 하는지 확인하여 변환
4. 원래 요청을 보냈던 내부 네트워크의 컴퓨터로 응답 패킷 전달

### NAT 유형
#### 정적 NAT
하나의 사설 IP 주소와 하나의 공인 IP 주소를 1 : 1 매핑하는 방식. 즉, 내부 네트워크의 특정 사설 IP 주소는 항상 동일한 공인 IP 주소로 변환된다.

사설 IP 주소의 수만큼 공인 IP 주소가 필요해지기 때문에, 잘 사용되는 방식은 아니다.

#### 동적 NAT
사설 IP 주소를 공인 IP 주소 풀 내부의 사용 가능한 공인 IP 주소 중 하나로 변환하는 방식. 요청 시점에 사용 가능한 주소를 동적으로 받아서 매핑한다.

그렇기 때문에 공인 IP 주소는 고정되어있는 것이 아니라, 변경되는 값이다. 하지만 이 방법 역시 매핑을 위해 상당수의 공인 IP 주소가 필요하다는 단점이 존재한다.

#### PAT(Port Address Translation)
포트를 이용해서 하나의 공인 IP 주소에 많은 수의 사설 IP 주소를 매핑하는 방식. 단 하나의 공인 IP만으로 많은 수의 장치가 인터넷과 연결될 수 있기 때문에 가장 효율적인 방식이다.

포트 번호가 각 사설 IP와 연결된 트래픽을 구분하는 데 사용되기 때문에, 어떤 트래픽이 어떤 내부 장치로부터 온 것인지를 포트 번호를 통해 식별한다.

```text
203.0.113.25:8000 <=> 192.168.1.10
203.0.113.25:1000 <=> 192.168.0.11
```

## 포트 포워딩
포트 포워딩은 PAT과는 반대로 외부에서 내부의 특정 장치로 접속할 수 있도록 하는 기술이다. 외부 네트워크에서 특정 포트로 들어오는 트래픽을 라우터를 통해 내부 네트워크 안에 있는 특정 사설 IP 주소의 장치로 전달하도록 한다. 

일반적으로 내부 네트워크 내의 서버는 외부에서 접근할 수 없고, 내부 네트워크 내의 다른 장치들만 접근이 가능하다. 하지만 이를 극복하고 외부 네트워크에서의 접근을 허용하기 위해 포트 포워딩을 사용하게 된다.

### 포트 포워딩의 작동 방법
1. 외부 클라이언트는 서버에 접속하기 위해 대상 네트워크의 IP 주소와 특정 포트 번호를 사용함 (예를 들면 웹 서버 80)
2. 라우터가 이 요청을 받으면 설정된 포트 포워딩 규칙을 확인
	- 이 규칙은 `공인 IP 주소의 X번 포트로 들어오는 트래픽은 내부 네트워크의 Y IP 주소에 있는 Z번 포트로 보내라` 와 같음
3. 라우터는 규칙에 따라 목적지 주소를 공인 IP → 사설 IP로 변경하고, 필요하다면 포트 역시 변경하여 패킷을 전달
